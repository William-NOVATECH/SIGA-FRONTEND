<div class="formacion-academica-form">
  <button *ngIf="!showForm && !isEditMode" class="btn btn-primary" (click)="toggleForm()">
    + Agregar Formación Académica
  </button>

  <div *ngIf="showForm" class="form-container">
    <h4>{{ isEditMode ? 'Editar' : 'Nueva' }} Formación Académica</h4>

    <!-- Error -->
    <div *ngIf="error" class="error-message">
      {{ error }}
    </div>

    <form [formGroup]="formacionForm" (ngSubmit)="onSubmit()">
      <div class="form-grid">
        <div class="form-group">
          <label for="nivel_formacion">Nivel de Formación *</label>
          <select id="nivel_formacion" formControlName="nivel_formacion"
                  [class.error]="f['nivel_formacion'].invalid && f['nivel_formacion'].touched">
            <option value="">Seleccione un nivel</option>
            <option *ngFor="let nivel of nivelesFormacion" [value]="nivel">
              {{ nivel }}
            </option>
          </select>
          <div *ngIf="f['nivel_formacion'].invalid && f['nivel_formacion'].touched" class="error-text">
            Nivel de formación es requerido
          </div>
        </div>

        <div class="form-group">
          <label for="titulo">Título Obtenido *</label>
          <input type="text" id="titulo" formControlName="titulo"
                 [class.error]="f['titulo'].invalid && f['titulo'].touched">
          <div *ngIf="f['titulo'].invalid && f['titulo'].touched" class="error-text">
            Título es requerido
          </div>
        </div>

        <div class="form-group">
          <label for="institucion">Institución Educativa *</label>
          <input type="text" id="institucion" formControlName="institucion"
                 [class.error]="f['institucion'].invalid && f['institucion'].touched">
          <div *ngIf="f['institucion'].invalid && f['institucion'].touched" class="error-text">
            Institución es requerida
          </div>
        </div>

        <div class="form-group">
          <label for="anio_graduacion">Año de Graduación</label>
          <input type="number" id="anio_graduacion" formControlName="anio_graduacion"
                 min="1900" [max]="currentYear">
        </div>

        <div class="form-group">
          <label for="pais">País</label>
          <input type="text" id="pais" formControlName="pais">
        </div>

        <div class="form-group full-width">
          <label for="documento_file">
            <i class="fa-solid fa-file-upload form-label-icon"></i>
            Documento del Título
          </label>
          
          <!-- Input de archivo -->
          <div class="file-upload-container">
            <input 
              type="file" 
              id="documento_file" 
              class="file-input"
              accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx"
              (change)="onFileSelected($event)"
              [disabled]="uploading || saving">
            
            <label for="documento_file" class="file-upload-label" [class.uploading]="uploading" [class.has-file]="fileName">
              <div class="file-upload-content">
                <i *ngIf="!uploading && !fileName" class="fa-solid fa-cloud-arrow-up file-upload-icon"></i>
                <i *ngIf="uploading" class="fa-solid fa-spinner fa-spin file-upload-icon"></i>
                <i *ngIf="!uploading && fileName" class="fa-solid fa-file-check file-upload-icon"></i>
                <span class="file-upload-text">
                  <span *ngIf="!uploading && !fileName">Seleccionar archivo (PDF, imagen o Word - máx 10MB)</span>
                  <span *ngIf="uploading">Subiendo archivo...</span>
                  <span *ngIf="!uploading && fileName">{{ fileName }}</span>
                </span>
              </div>
            </label>

            <!-- Preview de imagen -->
            <div *ngIf="filePreview && selectedFile && selectedFile.type.startsWith('image/')" class="file-preview">
              <img [src]="filePreview" alt="Preview" class="preview-image">
              <button type="button" class="btn-remove-preview" (click)="removeFile()" title="Eliminar archivo">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>

            <!-- Botón para eliminar archivo si ya está subido -->
            <div *ngIf="fileName && !selectedFile && formacionForm.get('documento_titulo')?.value" class="file-info">
              <div class="file-info-content">
                <i class="fa-solid fa-file-pdf"></i>
                <span>{{ fileName }}</span>
                <a [href]="formacionForm.get('documento_titulo')?.value" target="_blank" class="btn-view-file" title="Ver documento">
                  <i class="fa-solid fa-external-link"></i>
                </a>
                <button type="button" class="btn-remove-file" (click)="removeFile()" title="Eliminar archivo">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Campo oculto para la URL (solo para el formulario) -->
          <input type="hidden" formControlName="documento_titulo" id="documento_titulo_hidden">
          
          <div class="file-help-text">
            <i class="fa-solid fa-info-circle"></i>
            Formatos permitidos: PDF, JPG, PNG, GIF, DOC, DOCX. Tamaño máximo: 10MB
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="saving">
          {{ saving ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Guardar') }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="saving">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>