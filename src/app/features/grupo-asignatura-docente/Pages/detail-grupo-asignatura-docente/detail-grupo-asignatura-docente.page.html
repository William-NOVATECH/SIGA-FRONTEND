<div class="page-container">
  <div class="detail-header">
    <button (click)="onBack()" class="btn btn-back">
      <i class="fa-solid fa-arrow-left"></i>
      Volver
    </button>
    <h1>Detalles de Asignación</h1>
    <div class="header-actions">
      <button (click)="onEdit()" class="btn btn-edit btn-sm" [disabled]="!asignacion" title="Editar">
        <i class="fa-solid fa-pencil"></i>
        Editar
      </button>
      <button (click)="onDelete()" class="btn btn-delete btn-sm" [disabled]="!asignacion" title="Eliminar">
        <i class="fa-solid fa-trash"></i>
        Eliminar
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    Cargando detalles...
  </div>

  <!-- Error -->
  <div *ngIf="error && !loading" class="error-message">
    ❌ {{ error }}
  </div>

  <!-- Detalles -->
  <div *ngIf="asignacion && !loading" class="detail-card">
    <div class="card-header">
      <h2><i class="fa-solid fa-info-circle"></i> Información de la Asignación</h2>
      <div class="header-badges">
        <span [class]="getEstadoClass(asignacion.estado)" class="estado-badge badge-sm">
          {{ asignacion.estado }}
        </span>
        <span *ngIf="asignacion.estado_aprobacion" 
              [class]="getEstadoAprobacionClass(asignacion.estado_aprobacion)" 
              class="estado-aprobacion-badge badge-sm">
          <i class="fa-solid" [ngClass]="{
            'fa-file-pen': asignacion.estado_aprobacion === 'borrador',
            'fa-clock': asignacion.estado_aprobacion === 'pendiente_revision' || asignacion.estado_aprobacion === 'pendiente_aprobacion',
            'fa-check-circle': asignacion.estado_aprobacion === 'revisada',
            'fa-check-double': asignacion.estado_aprobacion === 'aprobada',
            'fa-times-circle': asignacion.estado_aprobacion === 'rechazada'
          }"></i>
          {{ asignacion.estado_aprobacion | titlecase }}
        </span>
        <span *ngIf="asignacion.version_actual" class="version-badge badge-sm">
          <i class="fa-solid fa-code-branch"></i>
          v{{ asignacion.version_actual }}
        </span>
      </div>
    </div>

    <div class="card-body">
      <div class="detail-grid">
        
        <!-- Grupo y Carrera -->
<div class="detail-section">
  <h3><i class="fa-solid fa-users"></i> Grupo y Carrera</h3>
  <div class="detail-item">
    <label>Código Grupo:</label>
    <span>{{ asignacion.grupo.codigo_grupo }}</span>
  </div>
  <div class="detail-item">
    <label>Nombre Grupo:</label>
    <span>{{ asignacion.grupo.nombre_grupo || 'N/A' }}</span>
  </div>
  <div class="detail-item">
    <label>Carrera:</label>
    <span class="info-value">
      {{ asignacion.grupo.carrera.nombre_carrera || 'No especificada' }}
      <span *ngIf="asignacion.grupo.carrera.codigo_carrera" class="codigo">
        ({{ asignacion.grupo.carrera.codigo_carrera }})
      </span>
    </span>
  </div>
</div>
        <!-- Asignatura -->
<div class="detail-section">
  <h3><i class="fa-solid fa-book"></i> Asignatura</h3>
           <div class="detail-item" *ngIf="asignacion.asignatura">
            <label>Código:</label>
            <span>{{ asignacion.asignatura.codigo_asignatura || 'N/A' }}</span>
          </div>
          <div class="detail-item" *ngIf="asignacion.asignatura">
            <label>Nombre:</label>
            <span>{{ asignacion.asignatura.nombre_asignatura }}</span>
          </div>
        </div>

        <!-- Docente -->
<div class="detail-section">
  <h3><i class="fa-solid fa-chalkboard-teacher"></i> Docente</h3>
            <div class="detail-item" *ngIf="asignacion.docente">
            <label>Código:</label>
            <span>{{ asignacion.docente.codigo_docente || 'N/A' }}</span>
          </div>
          <div class="detail-item" *ngIf="asignacion.docente">
            <label>Nombre:</label>
            <span>
              {{ asignacion.docente.nombres }} 
              {{ asignacion.docente.apellidos }}
            </span>
          </div>
        </div>

        <!-- Información de Asignación -->
<div class="detail-section">
  <h3><i class="fa-solid fa-clipboard-list"></i> Información de Asignación</h3>
          <div class="detail-item">
            <label>Fecha de Asignación:</label>
            <span class="info-value">{{ asignacion.fecha_asignacion | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="detail-item">
            <label>Estado:</label>
            <span [class]="getEstadoClass(asignacion.estado)" class="estado-badge">
              {{ asignacion.estado }}
            </span>
          </div>
          <div class="detail-item" *ngIf="asignacion.observaciones">
            <label>Observaciones:</label>
            <span class="observaciones">{{ asignacion.observaciones }}</span>
          </div>
        </div>

        <!-- Información del Creador -->
<div class="detail-section" *ngIf="asignacion.id_coordinador_carrera">
  <h3><i class="fa-solid fa-user"></i> Información del Creador</h3>
          <div class="detail-item">
            <label>Creado por:</label>
            <span class="info-value">
              <span *ngIf="loadingCreador">
                <i class="fa-solid fa-spinner fa-spin"></i> Cargando...
              </span>
              <span *ngIf="!loadingCreador">
                <strong>{{ getNombreUsuarioCreador() }}</strong>
                <span *ngIf="usuarioCreador && usuarioCreador.email" class="email-info">
                  ({{ usuarioCreador.email }})
                </span>
                <span *ngIf="esUsuarioCreador()" class="badge-creador">
                  <i class="fa-solid fa-check-circle"></i> Eres el creador
                </span>
              </span>
            </span>
          </div>
          <div class="detail-item" *ngIf="asignacion.fecha_creacion_inicial">
            <label>Fecha de Creación:</label>
            <span class="info-value">{{ asignacion.fecha_creacion_inicial | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="detail-item" *ngIf="!asignacion.id_coordinador_carrera">
            <label class="warning-label">
              <i class="fa-solid fa-exclamation-triangle"></i>
              No se registró el usuario creador
            </label>
          </div>
        </div>

        <!-- Observaciones por Rol -->
<div class="detail-section" *ngIf="asignacion.observaciones_coordinador || asignacion.observaciones_director || asignacion.observaciones_administrador">
  <h3><i class="fa-solid fa-comments"></i> Observaciones</h3>
          
          <div class="detail-item" *ngIf="asignacion.observaciones_coordinador">
            <label>Observaciones del Coordinador:</label>
            <span class="observaciones">{{ asignacion.observaciones_coordinador }}</span>
          </div>

          <div class="detail-item" *ngIf="asignacion.observaciones_director">
            <label>Observaciones del Director:</label>
            <span class="observaciones">{{ asignacion.observaciones_director }}</span>
          </div>

          <div class="detail-item" *ngIf="asignacion.observaciones_administrador">
            <label>Observaciones del Administrador:</label>
            <span class="observaciones">{{ asignacion.observaciones_administrador }}</span>
          </div>
        </div>

      </div>
    </div>

    <!-- Componente Visual del Flujo de Versionamiento -->
    <app-versionamiento-flow [asignacion]="asignacion"></app-versionamiento-flow>

    <!-- Botones de Acción del Flujo de Aprobación -->
    <div class="card-footer" *ngIf="asignacion">
      <!-- Mensaje informativo para coordinador en borrador -->
      <div *ngIf="isCoordinador() && asignacion.estado_aprobacion === 'borrador' && !canEnviarRevision()" 
           class="info-message">
        <i class="fa-solid fa-info-circle"></i>
        <div>
          <strong>No puedes enviar esta asignación a revisión</strong>
          <p *ngIf="asignacion.id_coordinador_carrera">
            Esta asignación fue creada por: <strong>{{ getNombreUsuarioCreador() }}</strong>.
            Solo el coordinador que creó esta asignación puede enviarla a revisión.
          </p>
          <p *ngIf="!asignacion.id_coordinador_carrera">
            Esta asignación no tiene un coordinador creador registrado. Por favor, contacta al administrador del sistema.
          </p>
          <p *ngIf="esUsuarioCreador() && !isCoordinador()">
            <strong>Nota:</strong> Eres el creador de esta asignación, pero tu rol actual no es Coordinador. Verifica que tengas el rol de Coordinador activo.
          </p>
        </div>
      </div>

      <div class="flow-actions">
        <!-- Botón: Enviar a Revisión (Coordinador) -->
        <button *ngIf="canEnviarRevision()" 
                (click)="onEnviarRevision()" 
                class="btn btn-flow btn-send-review btn-compact"
                [disabled]="loading">
          <i class="fa-solid fa-paper-plane"></i>
          Enviar a Revisión
        </button>

        <!-- Botones: Revisar (Director) -->
        <div *ngIf="canRevisar()" class="review-actions">
          <button (click)="onOpenRevisarModal(true)" 
                  class="btn btn-flow btn-approve-review btn-compact"
                  [disabled]="loading">
            <i class="fa-solid fa-check-circle"></i>
            Aprobar
          </button>
          <button (click)="onOpenRevisarModal(false)" 
                  class="btn btn-flow btn-reject-review btn-compact"
                  [disabled]="loading">
            <i class="fa-solid fa-times-circle"></i>
            Rechazar
          </button>
        </div>

        <!-- Botón: Aprobar Final (Administrador) -->
        <button *ngIf="canAprobarFinal()" 
                (click)="onOpenAprobarFinalModal()" 
                class="btn btn-flow btn-approve-final btn-compact"
                [disabled]="loading">
          <i class="fa-solid fa-check-double"></i>
          Aprobar Final
        </button>
      </div>

      <!-- Botones de Versionamiento -->
      <div class="version-actions">
        <button (click)="loadVersiones()" 
                class="btn btn-secondary btn-sm btn-compact"
                [disabled]="loadingVersiones">
          <i class="fa-solid fa-history"></i>
          Historial
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Historial de Versiones -->
  <div *ngIf="showHistorialModal" class="modal-overlay" (click)="showHistorialModal = false">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="fa-solid fa-history"></i>
          Historial de Versiones
        </h3>
        <button class="btn-close" (click)="showHistorialModal = false">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div *ngIf="loadingVersiones" class="loading-state">
          <div class="spinner"></div>
          <p>Cargando versiones...</p>
        </div>
        <div *ngIf="!loadingVersiones && versiones.length === 0" class="empty-state">
          <p>No hay versiones registradas</p>
        </div>
        <div *ngIf="!loadingVersiones && versiones.length > 0" class="versiones-list">
          <div *ngFor="let version of versiones" class="version-item" [class.active]="version.activa">
            <div class="version-header">
              <div class="version-info">
                <span class="version-number">Versión {{ version.version }}</span>
                <span class="version-status" [ngClass]="'status-' + version.estado_version">
                  {{ version.estado_version | titlecase }}
                </span>
                <span *ngIf="version.activa" class="version-active-badge">
                  <i class="fa-solid fa-check"></i>
                  Activa
                </span>
              </div>
              <div class="version-actions">
                <button *ngIf="!version.activa && (isCoordinador() || isAdministrador())"
                        (click)="onRestaurarVersion(version.id_version)"
                        class="btn btn-sm btn-restore"
                        title="Restaurar esta versión">
                  <i class="fa-solid fa-rotate-left"></i>
                  Restaurar
                </button>
              </div>
            </div>
            <div class="version-details">
              <div class="version-meta">
                <div class="meta-item">
                  <i class="fa-solid fa-user"></i>
                  <span><strong>Creador:</strong> {{ version.usuario_creador?.username || 'N/A' }}</span>
                </div>
                <div class="meta-item" *ngIf="version.usuario_revisor">
                  <i class="fa-solid fa-user-check"></i>
                  <span><strong>Revisor:</strong> {{ version.usuario_revisor.username }}</span>
                </div>
                <div class="meta-item" *ngIf="version.usuario_aprobador">
                  <i class="fa-solid fa-user-shield"></i>
                  <span><strong>Aprobador:</strong> {{ version.usuario_aprobador.username }}</span>
                </div>
                <div class="meta-item">
                  <i class="fa-solid fa-calendar"></i>
                  <span><strong>Fecha:</strong> {{ formatDate(version.fecha_creacion) }}</span>
                </div>
              </div>
              <div *ngIf="version.observaciones" class="version-observations">
                <strong>Observaciones:</strong>
                <p>{{ version.observaciones }}</p>
              </div>
              <div *ngIf="version.cambios && version.cambios.length > 0" class="version-changes">
                <strong>Cambios:</strong>
                <ul>
                  <li *ngFor="let cambio of version.cambios">
                    <strong>{{ cambio.campo }}:</strong> 
                    {{ cambio.valor_anterior }} → {{ cambio.valor_nuevo }}
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showHistorialModal = false">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Comparar Versiones -->
  <div *ngIf="showCompararModal" class="modal-overlay" (click)="showCompararModal = false">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="fa-solid fa-code-compare"></i>
          Comparar Versiones
        </h3>
        <button class="btn-close" (click)="showCompararModal = false">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div *ngIf="!comparacionResult" class="comparison-selector">
          <div class="selector-group">
            <label>Versión 1:</label>
            <select [(ngModel)]="version1Selected" class="form-select">
              <option [value]="undefined">Seleccionar versión</option>
              <option *ngFor="let v of versiones" [value]="v.version">
                Versión {{ v.version }} - {{ v.estado_version }}
              </option>
            </select>
          </div>
          <div class="selector-group">
            <label>Versión 2:</label>
            <select [(ngModel)]="version2Selected" class="form-select">
              <option [value]="undefined">Seleccionar versión</option>
              <option *ngFor="let v of versiones" [value]="v.version">
                Versión {{ v.version }} - {{ v.estado_version }}
              </option>
            </select>
          </div>
          <button (click)="onCompararVersiones()" 
                  class="btn btn-primary"
                  [disabled]="!version1Selected || !version2Selected || loading">
            <i class="fa-solid fa-code-compare"></i>
            Comparar
          </button>
        </div>
        <div *ngIf="comparacionResult" class="comparison-result">
          <div class="comparison-versions">
            <div class="version-column">
              <h4>Versión {{ comparacionResult.version1.version }}</h4>
              <div class="version-data">
                <p><strong>Estado:</strong> {{ comparacionResult.version1.estado_version }}</p>
                <p><strong>Fecha:</strong> {{ formatDate(comparacionResult.version1.fecha_creacion) }}</p>
                <p><strong>Docente ID:</strong> {{ comparacionResult.version1.datos_version.id_docente }}</p>
                <p><strong>Asignatura ID:</strong> {{ comparacionResult.version1.datos_version.id_asignatura }}</p>
              </div>
            </div>
            <div class="version-column">
              <h4>Versión {{ comparacionResult.version2.version }}</h4>
              <div class="version-data">
                <p><strong>Estado:</strong> {{ comparacionResult.version2.estado_version }}</p>
                <p><strong>Fecha:</strong> {{ formatDate(comparacionResult.version2.fecha_creacion) }}</p>
                <p><strong>Docente ID:</strong> {{ comparacionResult.version2.datos_version.id_docente }}</p>
                <p><strong>Asignatura ID:</strong> {{ comparacionResult.version2.datos_version.id_asignatura }}</p>
              </div>
            </div>
          </div>
          <div *ngIf="comparacionResult.diferencias && comparacionResult.diferencias.length > 0" class="diferencias">
            <h4>Diferencias:</h4>
            <ul>
              <li *ngFor="let diff of comparacionResult.diferencias">
                <strong>{{ diff.campo }}:</strong>
                <span class="old-value">{{ diff.valor_v1 }}</span>
                <i class="fa-solid fa-arrow-right"></i>
                <span class="new-value">{{ diff.valor_v2 }}</span>
              </li>
            </ul>
          </div>
          <div *ngIf="!comparacionResult.diferencias || comparacionResult.diferencias.length === 0" class="no-diferencias">
            <p>No hay diferencias entre las versiones seleccionadas.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showCompararModal = false; comparacionResult = null">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Revisar Carga Docente -->
  <div *ngIf="showRevisarModal" class="modal-overlay" (click)="onCloseRevisarModal()">
    <div class="modal-content modal-medium" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="fa-solid" [ngClass]="revisarForm.aprobado ? 'fa-check-circle' : 'fa-times-circle'"></i>
          {{ revisarForm.aprobado ? 'Aprobar Revisión' : 'Rechazar Revisión' }}
        </h3>
        <button class="btn-close" (click)="onCloseRevisarModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="revision-form">
          <!-- Observaciones -->
          <div class="form-group">
            <label for="observaciones-revision">
              <i class="fa-solid fa-comment"></i>
              Observaciones {{ revisarForm.aprobado ? '(opcional)' : '' }}
            </label>
            <textarea 
              id="observaciones-revision"
              [(ngModel)]="revisarForm.observaciones"
              class="form-control"
              rows="4"
              placeholder="Ingresa tus observaciones sobre esta carga docente..."></textarea>
          </div>

          <!-- Cambios (solo si se aprueba) -->
          <div *ngIf="revisarForm.aprobado" class="changes-section">
            <h4>
              <i class="fa-solid fa-edit"></i>
              Cambios Sugeridos (opcional)
            </h4>
            <p class="help-text">Puedes sugerir cambios que se aplicarán al crear la nueva versión.</p>

            <!-- Cambiar Docente -->
            <div class="form-group">
              <label for="cambio-docente">
                <i class="fa-solid fa-user-tie"></i>
                Cambiar Docente
              </label>
              <select 
                id="cambio-docente"
                [(ngModel)]="revisarForm.cambios.id_docente"
                class="form-control">
                <option [value]="null">Mantener docente actual</option>
                <option *ngFor="let docente of docentesDisponibles" [value]="docente.id_docente">
                  {{ docente.nombres }} {{ docente.apellidos }}
                  <span *ngIf="docente.codigo_docente">({{ docente.codigo_docente }})</span>
                </option>
              </select>
              <small *ngIf="asignacion && revisarForm.cambios.id_docente === asignacion.id_docente" class="text-muted">
                No hay cambio de docente
              </small>
            </div>

            <!-- Cambiar Estado -->
            <div class="form-group">
              <label for="cambio-estado">
                <i class="fa-solid fa-toggle-on"></i>
                Cambiar Estado
              </label>
              <select 
                id="cambio-estado"
                [(ngModel)]="revisarForm.cambios.estado"
                class="form-control">
                <option [value]="null">Mantener estado actual</option>
                <option value="activa">Activa</option>
                <option value="finalizada">Finalizada</option>
                <option value="cancelada">Cancelada</option>
              </select>
              <small *ngIf="asignacion && revisarForm.cambios.estado === asignacion.estado" class="text-muted">
                No hay cambio de estado
              </small>
            </div>

            <!-- Observaciones para cambios -->
            <div class="form-group">
              <label for="observaciones-cambios">
                <i class="fa-solid fa-sticky-note"></i>
                Observaciones sobre los cambios
              </label>
              <textarea 
                id="observaciones-cambios"
                [(ngModel)]="revisarForm.cambios.observaciones"
                class="form-control"
                rows="2"
                placeholder="Explica el motivo de los cambios sugeridos..."></textarea>
            </div>

            <!-- Resumen de cambios -->
            <div *ngIf="hasChanges()" class="changes-summary">
              <h5>
                <i class="fa-solid fa-list-check"></i>
                Resumen de Cambios:
              </h5>
              <ul>
                <li *ngIf="revisarForm.cambios.id_docente && revisarForm.cambios.id_docente !== asignacion?.id_docente">
                  <strong>Docente:</strong> Será cambiado
                </li>
                <li *ngIf="revisarForm.cambios.estado && revisarForm.cambios.estado !== asignacion?.estado">
                  <strong>Estado:</strong> {{ asignacion?.estado }} → {{ revisarForm.cambios.estado }}
                </li>
                <li *ngIf="revisarForm.cambios.observaciones && revisarForm.cambios.observaciones.trim()">
                  <strong>Observaciones:</strong> Se agregarán observaciones
                </li>
              </ul>
            </div>
          </div>

          <!-- Mensaje de rechazo -->
          <div *ngIf="!revisarForm.aprobado" class="rejection-warning">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <p>Al rechazar esta carga docente, volverá al estado <strong>borrador</strong> y el coordinador deberá corregir y reenviar.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="onCloseRevisarModal()">
          <i class="fa-solid fa-times"></i>
          Cancelar
        </button>
        <button 
          class="btn" 
          [ngClass]="revisarForm.aprobado ? 'btn-primary' : 'btn-danger'"
          (click)="onConfirmRevisar()"
          [disabled]="loading">
          <i class="fa-solid" [ngClass]="revisarForm.aprobado ? 'fa-check' : 'fa-times'"></i>
          {{ loading ? 'Procesando...' : (revisarForm.aprobado ? 'Aprobar' : 'Rechazar') }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Aprobar Final -->
  <div *ngIf="showAprobarFinalModal" class="modal-overlay" (click)="onCloseAprobarFinalModal()">
    <div class="modal-content modal-medium" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="fa-solid fa-check-double"></i>
          Aprobación Final
        </h3>
        <button class="btn-close" (click)="onCloseAprobarFinalModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="revision-form">
          <div class="approval-info">
            <i class="fa-solid fa-info-circle"></i>
            <p>Al dar la aprobación final, esta carga docente quedará completamente aprobada y el proceso de aprobación finalizará.</p>
          </div>

          <!-- Observaciones -->
          <div class="form-group">
            <label for="observaciones-aprobacion">
              <i class="fa-solid fa-comment"></i>
              Observaciones (opcional)
            </label>
            <textarea 
              id="observaciones-aprobacion"
              [(ngModel)]="aprobarFinalForm.observaciones"
              class="form-control"
              rows="4"
              placeholder="Ingresa tus observaciones finales sobre esta carga docente..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="onCloseAprobarFinalModal()">
          <i class="fa-solid fa-times"></i>
          Cancelar
        </button>
        <button 
          class="btn btn-primary"
          (click)="onConfirmAprobarFinal()"
          [disabled]="loading">
          <i class="fa-solid fa-check-double"></i>
          {{ loading ? 'Procesando...' : 'Aprobar Finalmente' }}
        </button>
      </div>
    </div>
  </div>
</div>