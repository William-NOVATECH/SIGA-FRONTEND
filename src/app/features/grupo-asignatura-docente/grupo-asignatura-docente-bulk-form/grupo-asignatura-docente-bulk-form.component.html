<div class="form-container">
  <div class="form-card">
    <!-- Header -->
    <div class="form-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="fa-solid fa-users"></i>
        </div>
        <div class="header-text">
          <h1>Creación Masiva de Asignaciones</h1>
          <p>Asigna múltiples asignaturas y docentes a un grupo de manera simultánea</p>
        </div>
      </div>
    </div>

    <!-- Form Content -->
    <div class="form-content">
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <!-- Grupo -->
          <div class="form-group full-width">
            <label for="id_grupo" class="form-label">
              <i class="fa-solid fa-users form-label-icon"></i>
              Grupo <span class="required-star">*</span>
            </label>
            <div class="input-group">
              <select 
                id="id_grupo" 
                formControlName="id_grupo"
                class="form-select"
                [class.error]="form.get('id_grupo')?.invalid && form.get('id_grupo')?.touched"
                [disabled]="loadingGrupoPlan"
              >
                <option value="">Seleccionar grupo</option>
                <option *ngFor="let grupo of grupos" [value]="grupo.id_grupo">
                  {{ grupo.codigo_grupo }} - {{ grupo.nombre_grupo }}
                </option>
              </select>
              <i class="fa-solid fa-chevron-down select-arrow"></i>
            </div>
            <div *ngIf="form.get('id_grupo')?.invalid && form.get('id_grupo')?.touched" class="error-text">
              <i class="fa-solid fa-exclamation-circle error-text-icon"></i>
              Grupo es requerido
            </div>
            <div *ngIf="loadingGrupoPlan" class="form-help">
              <i class="fa-solid fa-spinner fa-spin"></i>
              Cargando plan del grupo...
            </div>
          </div>

          <!-- Plan (solo lectura, cargado automáticamente del grupo) -->
          <div class="form-group full-width" *ngIf="selectedGrupoPlan">
            <label class="form-label">
              <i class="fa-solid fa-calendar-days form-label-icon"></i>
              Plan del Grupo (automático)
            </label>
            <div class="input-group">
              <input 
                type="text"
                [value]="selectedGrupoPlan.codigo_plan + ' - ' + selectedGrupoPlan.nombre_plan + (selectedGrupoPlan['año'] ? ' (' + selectedGrupoPlan['año'] + ')' : '')"
                class="form-input"
                readonly
                style="background-color: #f3f4f6; cursor: not-allowed;"
              >
              <div class="input-icon">
                <i class="fa-solid fa-calendar-days"></i>
              </div>
            </div>
            <div class="form-help">
              <i class="fa-solid fa-info-circle"></i>
              El plan se carga automáticamente del grupo seleccionado
            </div>
          </div>

          <!-- Estado -->
          <div class="form-group">
            <label for="estado" class="form-label">
              <i class="fa-solid fa-toggle-on form-label-icon"></i>
              Estado <span class="required-star">*</span>
            </label>
            <div class="input-group">
              <select 
                id="estado" 
                formControlName="estado"
                class="form-select"
                [class.error]="form.get('estado')?.invalid && form.get('estado')?.touched"
              >
                <option *ngFor="let estado of estados" [value]="estado.value">
                  {{ estado.label }}
                </option>
              </select>
              <i class="fa-solid fa-chevron-down select-arrow"></i>
            </div>
            <div *ngIf="form.get('estado')?.invalid && form.get('estado')?.touched" class="error-text">
              <i class="fa-solid fa-exclamation-circle error-text-icon"></i>
              Estado es requerido
            </div>
          </div>

          <!-- Observaciones -->
          <div class="form-group full-width">
            <label for="observaciones" class="form-label">
              <i class="fa-solid fa-comment form-label-icon"></i>
              Observaciones
            </label>
            <div class="input-group">
              <textarea 
                id="observaciones" 
                formControlName="observaciones"
                class="form-textarea"
                rows="3"
                placeholder="Observaciones opcionales sobre las asignaciones..."
              ></textarea>
              <i class="fa-solid fa-align-left input-icon"></i>
            </div>
          </div>
        </div>

        <!-- Asignaturas y Docentes -->
        <div class="asignaturas-section">
          <div class="section-header">
            <h3>
              <i class="fa-solid fa-list-check"></i>
              Asignaturas y Docentes
            </h3>
            <button type="button" (click)="addAsignaturaDocente()" class="btn btn-sm btn-add">
              <i class="fa-solid fa-plus"></i>
              Agregar Asignatura
            </button>
          </div>

          <div formArrayName="asignaturas_docentes">
            <div 
              *ngFor="let item of asignaturasDocentesArray.controls; let i = index" 
              [formGroupName]="i"
              class="asignatura-item"
            >
              <div class="item-header">
                <h4>
                  <i class="fa-solid fa-book"></i>
                  Asignación {{ i + 1 }}
                </h4>
                <button 
                  *ngIf="asignaturasDocentesArray.length > 1"
                  type="button" 
                  (click)="removeAsignaturaDocente(i)" 
                  class="btn btn-sm btn-remove"
                  title="Eliminar esta asignación"
                >
                  <i class="fa-solid fa-trash"></i>
                  Eliminar
                </button>
              </div>

              <div class="item-fields">
                <!-- Asignatura -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fa-solid fa-book form-label-icon"></i>
                    Asignatura <span class="required-star">*</span>
                  </label>
                  <div class="input-group">
                    <select 
                      formControlName="id_asignatura"
                      class="form-select"
                      [class.error]="item.get('id_asignatura')?.invalid && item.get('id_asignatura')?.touched"
                    >
                      <option value="">Seleccionar asignatura</option>
                      <option *ngFor="let asignatura of asignaturas" [value]="asignatura.id_asignatura">
                        {{ asignatura.codigo_asignatura }} - {{ asignatura.nombre_asignatura }}
                      </option>
                    </select>
                    <i class="fa-solid fa-chevron-down select-arrow"></i>
                  </div>
                  <div *ngIf="item.get('id_asignatura')?.invalid && item.get('id_asignatura')?.touched" class="error-text">
                    <i class="fa-solid fa-exclamation-circle error-text-icon"></i>
                    Asignatura es requerida
                  </div>
                </div>

                <!-- Docente -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fa-solid fa-user-tie form-label-icon"></i>
                    Docente <span class="required-star">*</span>
                  </label>
                  <div class="input-group">
                    <select 
                      formControlName="id_docente"
                      class="form-select"
                      [class.error]="item.get('id_docente')?.invalid && item.get('id_docente')?.touched"
                    >
                      <option value="">Seleccionar docente</option>
                      <option *ngFor="let docente of docentes" [value]="docente.id_docente">
                        {{ docente.nombres }} {{ docente.apellidos }}
                        <span *ngIf="docente.codigo_docente"> ({{ docente.codigo_docente }})</span>
                      </option>
                    </select>
                    <i class="fa-solid fa-chevron-down select-arrow"></i>
                  </div>
                  <div *ngIf="item.get('id_docente')?.invalid && item.get('id_docente')?.touched" class="error-text">
                    <i class="fa-solid fa-exclamation-circle error-text-icon"></i>
                    Docente es requerido
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button 
            type="button" 
            (click)="onCancel()" 
            class="btn btn-secondary"
            [disabled]="loading"
          >
            <i class="fa-solid fa-times btn-secondary-icon"></i>
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="loading || form.invalid"
          >
            <i *ngIf="!loading" class="fa-solid fa-check btn-primary-icon"></i>
            <div *ngIf="loading" class="loading-spinner"></div>
            {{ loading ? 'Creando...' : 'Crear Asignaciones' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>