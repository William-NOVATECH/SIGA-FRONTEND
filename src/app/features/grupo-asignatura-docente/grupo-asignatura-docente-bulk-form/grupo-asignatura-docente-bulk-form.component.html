<div class="form-container">
  <div class="form-card">
    <!-- Header -->
    <div class="form-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="fa-solid fa-users"></i>
        </div>
        <div class="header-text">
          <h1>Creación Masiva de Asignaciones</h1>
          <p>Asigna múltiples asignaturas y docentes a un grupo</p>
        </div>
      </div>
    </div>

    <!-- Form Content -->
    <div class="form-content">
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <!-- Grupo -->
          <div class="form-group full-width">
            <label for="id_grupo" class="form-label">
              <i class="fa-solid fa-users form-label-icon"></i>
              Grupo <span class="required-star">*</span>
            </label>
            <div class="input-group">
              <select 
                id="id_grupo" 
                formControlName="id_grupo"
                class="form-select"
                [class.error]="form.get('id_grupo')?.invalid && form.get('id_grupo')?.touched"
                [disabled]="loadingGrupoPlan"
              >
                <option value="">Seleccionar grupo</option>
                <option *ngFor="let grupo of grupos" [value]="grupo.id_grupo">
                  {{ grupo.codigo_grupo }} - {{ grupo.nombre_grupo }}
                </option>
              </select>
              <i class="fa-solid fa-chevron-down select-arrow"></i>
            </div>
            <div *ngIf="form.get('id_grupo')?.invalid && form.get('id_grupo')?.touched" class="error-text">
              <i class="fa-solid fa-exclamation-circle error-text-icon"></i>
              Grupo es requerido
            </div>
            <div *ngIf="loadingGrupoPlan" class="form-help">
              <i class="fa-solid fa-spinner fa-spin"></i>
              Cargando plan del grupo...
            </div>
          </div>

          <!-- Plan (solo lectura, cargado automáticamente del grupo) -->
          <div class="form-group full-width" *ngIf="selectedGrupoPlan">
            <label class="form-label">
              <i class="fa-solid fa-calendar-days form-label-icon"></i>
              Plan del Grupo (automático)
            </label>
            <div class="input-group">
              <input 
                type="text"
                [value]="selectedGrupoPlan.codigo_plan + ' - ' + selectedGrupoPlan.nombre_plan + (selectedGrupoPlan['año'] ? ' (' + selectedGrupoPlan['año'] + ')' : '')"
                class="form-input"
                readonly
                style="background-color: #f3f4f6; cursor: not-allowed;"
              >
              <div class="input-icon">
                <i class="fa-solid fa-calendar-days"></i>
              </div>
            </div>
            <div class="form-help">
              <i class="fa-solid fa-info-circle"></i>
              El plan se carga automáticamente del grupo seleccionado
            </div>
          </div>

          <!-- Estado -->
          <div class="form-group">
            <label for="estado" class="form-label">
              <i class="fa-solid fa-toggle-on form-label-icon"></i>
              Estado <span class="required-star">*</span>
            </label>
            <div class="input-group">
              <select 
                id="estado" 
                formControlName="estado"
                class="form-select"
                [class.error]="form.get('estado')?.invalid && form.get('estado')?.touched"
              >
                <option *ngFor="let estado of estados" [value]="estado.value">
                  {{ estado.label }}
                </option>
              </select>
              <i class="fa-solid fa-chevron-down select-arrow"></i>
            </div>
            <div *ngIf="form.get('estado')?.invalid && form.get('estado')?.touched" class="error-text">
              <i class="fa-solid fa-exclamation-circle error-text-icon"></i>
              Estado es requerido
            </div>
          </div>

          <!-- Observaciones -->
          <div class="form-group full-width">
            <label for="observaciones" class="form-label">
              <i class="fa-solid fa-comment form-label-icon"></i>
              Observaciones
            </label>
            <div class="input-group">
              <textarea 
                id="observaciones" 
                formControlName="observaciones"
                class="form-textarea"
                rows="3"
                placeholder="Observaciones opcionales sobre las asignaciones..."
              ></textarea>
              <i class="fa-solid fa-align-left input-icon"></i>
            </div>
          </div>
        </div>

        <!-- Asignaturas y Docentes -->
        <div class="asignaturas-section" *ngIf="selectedGrupoCarrera">
          <div class="section-header">
            <div>
              <h3>
                <i class="fa-solid fa-list-check"></i>
                Asignaturas de la Carrera
              </h3>
              <p class="carrera-info">
                <i class="fa-solid fa-graduation-cap"></i>
                {{ selectedGrupoCarrera.nombre_carrera }}
              </p>
            </div>
            <div class="selection-count">
              {{ asignaturasSeleccionadas.size }} {{ asignaturasSeleccionadas.size === 1 ? 'asignación seleccionada' : 'asignaciones seleccionadas' }}
            </div>
          </div>

          <div *ngIf="filteredAsignaturas.length === 0" class="empty-asignaturas">
            <i class="fa-solid fa-inbox"></i>
            <p>No hay asignaturas disponibles para esta carrera</p>
          </div>

          <div *ngIf="filteredAsignaturas.length > 0" class="asignaturas-grid">
            <div 
              *ngFor="let asignatura of filteredAsignaturas" 
              class="asignatura-grid-item"
              [class.selected]="isAsignaturaSelected(asignatura.id_asignatura)"
            >
              <div class="asignatura-info">
                <div class="asignatura-header">
                  <h4>
                    <i class="fa-solid fa-book"></i>
                    {{ asignatura.codigo_asignatura }}
                  </h4>
                  <span *ngIf="isAsignaturaSelected(asignatura.id_asignatura)" class="selected-badge">
                    <i class="fa-solid fa-check-circle"></i>
                    Asignada
                  </span>
                </div>
                <p class="asignatura-name">{{ asignatura.nombre_asignatura }}</p>
                <div class="asignatura-meta">
                  <span *ngIf="asignatura.creditos" class="meta-item">
                    <i class="fa-solid fa-certificate"></i>
                    {{ asignatura.creditos }} créditos
                  </span>
                  <span *ngIf="asignatura.horas_semanales" class="meta-item">
                    <i class="fa-solid fa-clock"></i>
                    {{ asignatura.horas_semanales }} hrs/sem
                  </span>
                </div>
              </div>
              
              <div class="docente-select-wrapper">
                <label class="docente-label">
                  <i class="fa-solid fa-user-tie"></i>
                  Docente
                </label>
                <select 
                  class="docente-select"
                  [value]="getDocenteForAsignatura(asignatura.id_asignatura) || ''"
                  (change)="onAsignaturaDocenteChange(asignatura.id_asignatura, $any($event.target).value ? +$any($event.target).value : null)"
                >
                  <option value="">Seleccionar docente</option>
                  <option *ngFor="let docente of docentes" [value]="docente.id_docente">
                    {{ docente.nombres }} {{ docente.apellidos }}
                    <span *ngIf="docente.codigo_docente"> ({{ docente.codigo_docente }})</span>
                  </option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="!selectedGrupoCarrera && form.get('id_grupo')?.value" class="asignaturas-section waiting">
          <div class="waiting-message">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <p>Cargando información del grupo...</p>
          </div>
        </div>

        <div *ngIf="!form.get('id_grupo')?.value" class="asignaturas-section waiting">
          <div class="waiting-message">
            <i class="fa-solid fa-info-circle"></i>
            <p>Seleccione un grupo para ver las asignaturas disponibles</p>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button 
            type="button" 
            (click)="onCancel()" 
            class="btn btn-secondary"
            [disabled]="loading"
          >
            <i class="fa-solid fa-times btn-secondary-icon"></i>
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="loading || form.invalid"
          >
            <i *ngIf="!loading" class="fa-solid fa-check btn-primary-icon"></i>
            <div *ngIf="loading" class="loading-spinner"></div>
            {{ loading ? 'Creando...' : 'Crear Asignaciones' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>