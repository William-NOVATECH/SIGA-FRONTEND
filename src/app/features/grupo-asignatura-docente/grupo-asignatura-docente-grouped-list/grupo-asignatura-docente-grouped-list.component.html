<div class="container">
  <!-- Header -->
  <div class="header">
    <h2><i class="fa-solid fa-users-gear"></i> Asignaciones de Carga Docente</h2>
    <div class="actions">
      <div class="search-box">
        <i class="fa-solid fa-search search-icon"></i>
        <input
          type="text"
          placeholder="Buscar por grupo, carrera..."
          [(ngModel)]="searchTerm"
          (input)="onSearch()"
          class="search-input"
        />
      </div>
      <button (click)="onRefresh()" class="btn btn-secondary btn-compact" [disabled]="loading">
        <i class="fa-solid" [ngClass]="loading ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
        {{ loading ? 'Cargando...' : 'Actualizar' }}
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    Cargando grupos...
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && filteredGrupos.length === 0" class="empty-state">
    No se encontraron grupos con asignaciones
  </div>

  <!-- Lista de Grupos -->
  <div *ngIf="!loading && filteredGrupos.length > 0" class="grupos-list">
    
    <div *ngFor="let grupo of filteredGrupos" class="grupo-item">
      
      <!-- Header del Grupo -->
      <div class="grupo-header" (click)="toggleGrupo(grupo.id_grupo)">
        <div class="grupo-info">
          <i class="fa-solid expand-icon" [ngClass]="grupoExpandido === grupo.id_grupo ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
          <h3 class="grupo-codigo">{{ grupo.codigo_grupo }}</h3>
          <span class="grupo-nombre" *ngIf="grupo.nombre_grupo">{{ grupo.nombre_grupo }}</span>
          <span class="carrera-info">
            <i class="fa-solid fa-graduation-cap"></i>
            {{ grupo.carrera.nombre_carrera || 'Carrera no especificada' }}
            <span *ngIf="grupo.carrera.codigo_carrera">({{ grupo.carrera.codigo_carrera }})</span>
          </span>
        </div>
        
        <div class="grupo-stats">
          <span class="asignaciones-count">
            <i class="fa-solid fa-book"></i>
            {{ grupo.asignaciones.length }} asignatura(s)
          </span>
          <span class="fecha-actualizacion">
            <i class="fa-solid fa-clock"></i>
            {{ getFechaActualizacion(grupo) | date:'dd/MM/yyyy' }}
          </span>
          <span *ngIf="grupo.periodo_academico" class="periodo-academico">
            <i class="fa-solid fa-calendar-alt"></i>
            {{ grupo.periodo_academico }}
          </span>
        </div>
      </div>

      <!-- Tabla de Asignaciones (Se muestra solo si el grupo está expandido) -->
      <div *ngIf="grupoExpandido === grupo.id_grupo" class="asignaciones-table-container">
        
        <div class="table-header">
          <h4><i class="fa-solid fa-list"></i> Asignaturas del Grupo {{ grupo.codigo_grupo }}</h4>
          <button (click)="onCreateAsignacion(grupo.id_grupo)" class="btn btn-primary btn-compact">
            <i class="fa-solid fa-plus"></i>
            Agregar
          </button>
        </div>

        <table class="asignaciones-table" *ngIf="grupo.asignaciones.length > 0">
          <thead>
            <tr>
              <th>Código</th>
              <th>Asignatura</th>
              <th>Docente</th>
              <th>Código Docente</th>
              <th>Fecha Asignación</th>
              <th>Estado</th>
              <th>Versión/Aprobación</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let asignacion of grupo.asignaciones">
              <td>
                <strong>{{ asignacion.asignatura.codigo_asignatura || 'N/A' }}</strong>
              </td>
              <td>{{ asignacion.asignatura.nombre_asignatura || 'Sin nombre' }}</td>
              <td>
                <span *ngIf="asignacion.docente">
                  {{ asignacion.docente.nombres }} {{ asignacion.docente.apellidos }}
                </span>
                <span *ngIf="!asignacion.docente" class="no-data">N/A</span>
              </td>
              <td>
                <span *ngIf="asignacion.docente?.codigo_docente" class="docente-codigo">
                  {{ asignacion.docente.codigo_docente }}
                </span>
                <span *ngIf="!asignacion.docente?.codigo_docente" class="no-codigo">
                  N/A
                </span>
              </td>
              <td>
                <span *ngIf="asignacion.fecha_asignacion">
                  {{ asignacion.fecha_asignacion | date:'dd/MM/yyyy' }}
                </span>
                <span *ngIf="!asignacion.fecha_asignacion" class="no-data">N/A</span>
              </td>
              <td>
                <span [class]="getEstadoClass(asignacion.estado)" class="estado-badge">
                  {{ asignacion.estado || 'N/A' }}
                </span>
              </td>
              <td>
                <div class="versionamiento-info">
                  <span *ngIf="asignacion.estado_aprobacion" 
                        [class]="getEstadoAprobacionClass(asignacion.estado_aprobacion)" 
                        class="estado-aprobacion-badge">
                    <i class="fa-solid" [ngClass]="getEstadoAprobacionIcon(asignacion.estado_aprobacion)"></i>
                    {{ getEstadoAprobacionLabel(asignacion.estado_aprobacion) }}
                  </span>
                  <span *ngIf="asignacion.version_actual" class="version-badge">
                    <i class="fa-solid fa-code-branch"></i>
                    v{{ asignacion.version_actual }}
                  </span>
                  <span *ngIf="!asignacion.estado_aprobacion && !asignacion.version_actual" class="no-versionamiento">
                    Sin versionamiento
                  </span>
                </div>
              </td>
              <td>
                <span *ngIf="asignacion.observaciones" class="observaciones-text" [title]="asignacion.observaciones">
                  {{ asignacion.observaciones.length > 50 ? (asignacion.observaciones.substring(0, 50) + '...') : asignacion.observaciones }}
                </span>
                <span *ngIf="!asignacion.observaciones" class="no-observaciones">
                  -
                </span>
              </td>
              <td class="actions-cell">
                <button 
                  (click)="onView(asignacion.id_grupo_asignatura_docente)" 
                  class="btn btn-sm btn-view"
                  title="Ver detalles"
                >
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button 
                  (click)="onEdit(asignacion.id_grupo_asignatura_docente)" 
                  class="btn btn-sm btn-edit"
                  title="Editar asignación"
                >
                  <i class="fa-solid fa-pencil"></i>
                </button>
                <button 
                  (click)="onDelete(asignacion.id_grupo_asignatura_docente)" 
                  class="btn btn-sm btn-delete"
                  title="Eliminar asignación"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Mensaje si no hay asignaciones -->
        <div *ngIf="grupo.asignaciones.length === 0" class="no-asignaciones">
          <i class="fa-solid fa-inbox"></i>
          <p>No hay asignaturas asignadas a este grupo.</p>
          <button (click)="onCreateAsignacion(grupo.id_grupo)" class="btn btn-primary btn-compact">
            <i class="fa-solid fa-plus"></i>
            Agregar primera asignatura
          </button>
        </div>

      </div>
    </div>
  </div>
</div>